<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Creator - Automated Pipeline</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>üé¨ Video Creator</h1>
            <p class="subtitle">Automated video generation from documents</p>
            <nav class="quick-links" style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="/script-parser.html" class="btn btn-secondary"
                    style="text-decoration: none; font-size: 0.9rem;">
                    üìú Script Parser
                </a>
                <a href="/code-screenshot.html" class="btn btn-secondary"
                    style="text-decoration: none; font-size: 0.9rem;">
                    üì∏ Code Screenshot
                </a>
            </nav>
        </header>

        <main>
            <!-- Login Setup -->
            <section class="card">
                <h2>üîê Login Setup</h2>
                <p style="margin-bottom: 1rem; color: var(--text-muted);">
                    First time? Click "Setup Login" to log into all services. Your sessions will be saved.
                </p>
                <div class="input-group">
                    <button onclick="setupLogin()" class="btn btn-primary" id="loginBtn">
                        üîê Setup Login
                    </button>
                    <button onclick="verifySessions()" class="btn btn-secondary" id="verifyBtn">
                        ‚úì Verify Sessions
                    </button>
                    <button onclick="testPerplexity()" class="btn btn-success" id="testPerplexityBtn">
                        üß™ Run Pipeline (Perplexity ‚Üí NotebookLM)
                    </button>
                    <span id="sessionStatus" class="session-status">Not verified</span>
                </div>
                <div id="testResults" style="margin-top: 1rem; display: none;">
                    <p style="color: var(--text-muted); font-size: 0.9rem;" id="testMessage"></p>
                </div>
            </section>

            <!-- Step 1: Select Document Folder -->
            <section class="card">
                <h2>üìÅ Step 1: Select Document Folder</h2>
                <div class="input-group" style="flex-wrap: wrap; gap: 0.5rem;">
                    <button onclick="selectLocalFolder()" class="btn btn-primary" id="selectFolderBtn"
                        style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">
                        üìÇ Add Folder
                    </button>
                    <button onclick="clearLocalFolders()" class="btn btn-secondary">
                        üóëÔ∏è Clear All
                    </button>
                    <div id="folderPath" class="folder-name"
                        style="flex: 1; min-width: 200px; padding: 0.5rem; background: var(--bg); border-radius: 0.25rem;">
                        No
                        folder selected</div>
                </div>
                <small class="hint" style="display: block; margin-top: 0.5rem;">Output will be saved to: <strong
                        id="outputPathPreview">[Selected Folder]/output/</strong></small>

                <!-- Parent Folder Scanner -->
                <details style="margin-top: 1rem; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; user-select: none;">
                        üìÇ Scan Parent Folder for Subdirectories
                    </summary>
                    <div style="margin-top: 12px;">
                        <p class="hint" style="margin-bottom: 8px;">
                            Enter a parent folder path to scan all its subdirectories. You can then select which ones to
                            add.
                        </p>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 12px;">
                            <input type="text" id="parentFolderPath" placeholder="F:\Workspaces\MyProject"
                                style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); color: var(--text);">
                            <button onclick="scanParentFolder()" class="btn btn-secondary">
                                üîç Scan
                            </button>
                        </div>
                        <div id="subdirectoryList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Populated after scan -->
                        </div>
                    </div>
                </details>

                <div id="documentList" class="document-list" style="margin-top: 1rem;"></div>
            </section>

            <!-- Step 2: Configure Settings -->
            <section class="card">
                <h2>‚öôÔ∏è Step 2: Configure Video Settings</h2>

                <!-- Profile Selector (Always visible) -->
                <div class="form-group">
                    <label for="activeProfile">üîê Active Browser Profile:</label>
                    <select id="activeProfile" onchange="onProfileChange()"
                        style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 100%;">
                        <option value="profile1">Profile 1</option>
                        <option value="profile2">Profile 2</option>
                        <option value="profile3">Profile 3</option>
                        <option value="profile4">Profile 4</option>
                    </select>
                    <small class="hint">Each profile has separate browser logins</small>
                </div>

                <hr style="margin: 1.5rem 0; border-color: var(--border);">

                <!-- Profile-Specific Settings (Expandable) -->
                <details open>
                    <summary style="cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-bottom: 1rem;">
                        üìã Profile-Specific Settings
                    </summary>

                    <div class="form-group">
                        <label for="perplexityChatUrl">Perplexity Chat URL for generating video prompt</label>
                        <input type="text" id="perplexityChatUrl" placeholder="https://www.perplexity.ai/search/...">
                        <small class="hint">URL for this profile's video prompt generation</small>
                    </div>

                    <div class="form-group">
                        <label for="audioNarrationPerplexityUrl">Perplexity Chat URL for audio narration</label>
                        <input type="text" id="audioNarrationPerplexityUrl"
                            placeholder="https://www.perplexity.ai/search/...">
                        <small class="hint">URL for this profile's audio narration generation</small>
                    </div>

                    <button onclick="saveProfileSettings()" class="btn btn-primary"
                        style="width: 100%; margin-top: 1rem;">
                        üíæ Save Profile Settings
                    </button>
                    <p id="saveProfileMessage"
                        style="text-align: center; margin-top: 0.5rem; color: var(--success); display: none;">
                        ‚úì Profile settings saved!
                    </p>
                </details>

                <hr style="margin: 1.5rem 0; border-color: var(--border);">

                <!-- Common Settings (Expandable) -->
                <details>
                    <summary style="cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-bottom: 1rem;">
                        üåê Common Settings (All Profiles)
                    </summary>

                    <div class="form-group">
                        <label for="perplexityModel">Perplexity Model:</label>
                        <select id="perplexityModel"
                            style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 100%;">
                            <option value="Best">Best (Default)</option>
                            <option value="Sonar">Sonar</option>
                            <option value="GPT-5.2">GPT-5.2</option>
                            <option value="Claude Opus 4.5">Claude Opus 4.5</option>
                            <option value="Gemini 3 Pro">Gemini 3 Pro</option>
                            <option value="Gemini 3 Flash">Gemini 3 Flash</option>
                            <option value="Grok 4.1">Grok 4.1</option>
                            <option value="Kimi K2 Thinking">Kimi K2 Thinking</option>
                            <option value="Claude Sonnet 4.5">Claude Sonnet 4.5</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="audioNarrationPerplexityModel">Audio Narration Perplexity Model:</label>
                        <select id="audioNarrationPerplexityModel"
                            style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; width: 100%;">
                            <option value="Best">Best (Default)</option>
                            <option value="Sonar">Sonar</option>
                            <option value="GPT-5.2">GPT-5.2</option>
                            <option value="Claude Opus 4.5">Claude Opus 4.5</option>
                            <option value="Gemini 3 Pro">Gemini 3 Pro</option>
                            <option value="Gemini 3 Flash">Gemini 3 Flash</option>
                            <option value="Grok 4.1">Grok 4.1</option>
                            <option value="Kimi K2 Thinking">Kimi K2 Thinking</option>
                            <option value="Claude Sonnet 4.5">Claude Sonnet 4.5</option>
                        </select>
                        <small class="hint">Model used for generating audio narration via Perplexity</small>
                    </div>

                    <div class="form-group">
                        <label for="promptText">Prompt Template:</label>
                        <textarea id="promptText" rows="4"
                            placeholder="Enter your video generation prompt here..."></textarea>
                        <small class="hint">Used if no Perplexity URL is provided</small>
                    </div>

                    <div class="form-group">
                        <label for="notebookLmChatSettings">NotebookLM Chat Settings</label>
                        <textarea id="notebookLmChatSettings" rows="3"
                            placeholder="Focus on key concepts and provide clear explanations...">Focus on key concepts and provide clear explanations</textarea>
                    </div>

                    <div class="form-group">
                        <label for="notebookLmStyleSettings">NotebookLM Style Settings</label>
                        <textarea id="notebookLmStyleSettings" rows="3"
                            placeholder="Modern, engaging, educational style">Modern, engaging, educational style</textarea>
                    </div>

                    <div class="form-group">
                        <label for="stylePrompt">Gemini Video Style Prompt</label>
                        <textarea id="stylePrompt" rows="3"
                            placeholder="Professional with smooth transitions">Professional with smooth transitions</textarea>
                    </div>

                    <div class="form-group">
                        <label for="audioNarrationPrompt">Audio Narration Prompt</label>
                        <textarea id="audioNarrationPrompt" rows="3"
                            placeholder="Generate slide-by-slide narration..."></textarea>
                    </div>

                    <!-- Delay Settings -->
                    <!-- Delay Settings -->
                    <div style="margin-top: 1rem; border: 1px dashed var(--border); padding: 10px; border-radius: 4px;">
                        <h4 style="margin-top: 0; margin-bottom: 10px;">‚è±Ô∏è Timing & Delays (Seconds)</h4>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label for="betweenVideoStartsMs" style="font-size: 0.9em;">Delay Between Videos</label>
                                <input type="number" id="betweenVideoStartsMs" value="300" step="1">
                                <small class="hint">Wait time before starting next video</small>
                            </div>
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label for="betweenAudioSlidesMs" style="font-size: 0.9em;">Delay Between Audio
                                    Slides</label>
                                <input type="number" id="betweenAudioSlidesMs" value="120" step="1">
                                <small class="hint">Wait time between audio generations</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="videoCheckIntervalMs" style="font-size: 0.9em;">Video Check Interval</label>
                                <input type="number" id="videoCheckIntervalMs" value="60" step="1">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="maxWaitForVideoMs" style="font-size: 0.9em;">Max Wait for Video</label>
                                <input type="number" id="maxWaitForVideoMs" value="600" step="1">
                            </div>
                        </div>
                    </div>

                    <!-- Google Studio dropdowns in 2-column grid -->
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="googleStudioModel">Google Studio Model</label>
                            <select id="googleStudioModel">
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="googleStudioVoice">Google Studio Voice</label>
                            <select id="googleStudioVoice">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="googleStudioStyleInstructions">Google Studio Style Instructions</label>
                        <textarea id="googleStudioStyleInstructions" rows="2"
                            placeholder="Voice style and tone instructions..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="sourceFolder">Local Source Folder Path (Absolute)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="sourceFolder" placeholder="e.g. F:\MyWork\Docs" style="flex: 1;"
                                onchange="updateAudioStartOptions(this.value)">
                            <button type="button" onclick="browseFolder()" class="btn btn-secondary"
                                style="white-space: nowrap; padding: 0.5rem 1rem;">üìÇ Browse</button>
                        </div>
                        <small class="hint">Files read from here, output saved to 'output' subfolder</small>
                    </div>

                    <div class="form-group">
                        <label for="outputDir">Output Directory Override (Optional)</label>
                        <input type="text" id="outputDir" placeholder="Leave empty to use source folder's output">
                    </div>

                    <!-- All checkboxes in single row -->
                    <div class="form-inline" style="flex-wrap: wrap; gap: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="headlessMode">
                            <label for="headlessMode" style="margin: 0; cursor: pointer;">Start Browser
                                Minimized</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="deleteConversation">
                            <label for="deleteConversation" style="margin: 0; cursor: pointer;">Delete Conversation
                                After</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="keepOpen">
                            <label for="keepOpen" style="margin: 0; cursor: pointer;">Keep Browser Open</label>
                        </div>
                    </div>

                    <button onclick="saveCommonSettings()" class="btn btn-primary"
                        style="width: 100%; margin-top: 1rem;">
                        üíæ Save Common Settings
                    </button>
                    <p id="saveCommonMessage"
                        style="text-align: center; margin-top: 0.5rem; color: var(--success); display: none;">
                        ‚úì Common settings saved!
                    </p>
                </details>
            </section>

            <!-- Step 3: Generate -->
            <section class="card">
                <h2>üöÄ Step 3: Generate Video</h2>
                <button onclick="generateVideo()" id="generateBtn" class="btn btn-success btn-large" disabled>
                    Generate Video
                </button>
                <p class="hint">Select documents first to enable generation</p>

                <hr style="margin: 1rem 0; border-color: var(--border);">

                <!-- Audio Pipeline Start Point -->
                <div id="audioStartContainer" style="display: none; margin-bottom: 0.75rem;">
                    <label for="audioStartPoint"
                        style="font-size: 0.9rem; font-weight: 500; display: block; margin-bottom: 0.375rem;">üéôÔ∏è Audio
                        Start Point:</label>
                    <select id="audioStartPoint" style="max-width: 300px;">
                        <!-- Options populated dynamically -->
                    </select>
                </div>

                <h3 style="margin-bottom: 0.5rem;">üîß Individual Tests</h3>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="testPerplexity()" class="btn btn-secondary">
                        üîç Test Perplexity
                    </button>
                    <button onclick="testNotebookLM()" class="btn btn-secondary">
                        üìì Test NotebookLM
                    </button>
                    <button onclick="testAudioPipeline()" class="btn btn-secondary">
                        üéôÔ∏è Test Audio Pipeline
                    </button>
                </div>
            </section>

            <!-- Progress Section -->
            <section class="card progress-section" id="progressSection" style="display: none;">
                <h2>üìä Progress</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressLog" class="progress-log"></div>
            </section>

            <!-- Batch Processing Section -->
            <section class="card" id="batchSection">
                <h2>üì¶ Batch Video Processing</h2>
                <p style="margin-bottom: 1rem; color: var(--text-muted);">
                    Process multiple folders with automatic video generation and profile rotation.
                </p>

                <!-- Profile Selector -->
                <div class="form-group">
                    <label style="font-weight: bold;">Select Profiles for Rotation:</label>
                    <div id="batchProfileSelector"
                        style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem;">
                        <!-- Populated dynamically -->
                    </div>
                    <small class="hint">Selected profiles will be rotated across folders to reduce rate limiting</small>
                </div>

                <!-- Folder List for Batch -->
                <div class="form-group">
                    <label style="font-weight: bold;">Folders to Process:</label>
                    <div id="batchFolderList"
                        style="margin-top: 0.5rem; max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                        <p style="color: var(--text-muted); font-style: italic;">Add folders using "üìÇ Add Folder" above
                        </p>
                    </div>
                </div>

                <!-- Batch Control Buttons -->
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                    <button onclick="startBatchProcessing()" class="btn btn-success" id="startBatchBtn" disabled>
                        ‚ñ∂Ô∏è Start Full Batch
                    </button>
                    <button onclick="startFirePhase()" class="btn btn-primary" id="fireOnlyBtn" disabled>
                        üî• Fire Videos Only
                    </button>
                    <button onclick="startCollectPhase()" class="btn btn-primary" id="collectOnlyBtn">
                        üì• Collect Videos
                    </button>
                    <button onclick="abortBatch()" class="btn btn-danger" id="abortBatchBtn" style="display: none;">
                        ‚èπÔ∏è Abort
                    </button>
                    <button onclick="resetBatch()" class="btn btn-warning" id="resetBatchBtn"
                        title="Reset stuck processing state">
                        üîÑ Reset
                    </button>
                </div>

                <!-- Batch Status Table -->
                <div id="batchStatusContainer" style="display: none; margin-top: 1rem;">
                    <h3>Batch Status</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: var(--bg-alt);">
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border);">
                                    Folder</th>
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border);">
                                    Profile</th>
                                <th
                                    style="padding: 0.5rem; text-align: center; border-bottom: 1px solid var(--border);">
                                    Status</th>
                                <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--border);">
                                    Elapsed</th>
                            </tr>
                        </thead>
                        <tbody id="batchStatusBody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Batch Log -->
                <div id="batchLogContainer" style="display: none; margin-top: 1rem;">
                    <h3>Batch Log</h3>
                    <div id="batchLog"
                        style="max-height: 200px; overflow-y: auto; background: var(--bg); padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem;">
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section class="card" id="resultsSection" style="display: none;">
                <h2>‚úÖ Results</h2>
                <div id="resultsContent"></div>
            </section>
        </main>

        <footer>
            <p>Status: <span id="status" class="status-idle">Idle</span></p>
        </footer>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="app.js"></script>
</body>

</html>